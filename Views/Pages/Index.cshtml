<div class="mb-4 mt-3">
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" href="@Url.Action("Index", "Pages")">Website pagina's</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="@Url.Action("Users", "Pages")">Website users</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="@Url.Action("Settings", "Pages")">Website instellingen</a>
        </li>
    </ul>
</div>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Message"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="container py-4">
<style>
    .table th:nth-child(1),
    .table td:nth-child(1) {
        width: 23%;
    }
    .table th:nth-child(2),
    .table td:nth-child(2) {
        width: 14%;
    }
    .table th:nth-child(3),
    .table td:nth-child(3) {
        width: 18%;
    }
    .table th:nth-child(4),
    .table td:nth-child(4) {
        width: 30%;
    }
    .table th:nth-child(5),
    .table td:nth-child(5) {
        width: 17%;
    }
    .table {
        table-layout: fixed;
    }
</style>
<table class="table table-striped">
    <thead>
        <tr>
            <th>Pagina Titel</th>
            <th>Menu Item</th>
            <th>Google Titel</th>
            <th>Google Omschrijving</th>
            <th class="text-end">Acties</th>
        </tr>
    </thead>
    <tbody>
    @{
        var pagesList = Model;
    }
    @for (int i = 0; i < pagesList.Count; i++)
    {
        var p = pagesList[i];
        var isFirst = i == 0;
        var isLast = i == pagesList.Count - 1;
        <tr class="page-row" data-page-id="@p.Id">
            <td>
                <span class="view-mode">@p.Title</span>
                <input type="text" class="edit-mode d-none form-control form-control-sm" value="@p.Title" data-field="Title" />
            </td>
            <td>
                <span class="view-mode">@p.MenuItem</span>
                <input type="text" class="edit-mode d-none form-control form-control-sm" value="@p.MenuItem" data-field="MenuItem" />
            </td>
            <td>
                <span class="view-mode">@p.GoogleTitle</span>
                <input type="text" class="edit-mode d-none form-control form-control-sm" value="@p.GoogleTitle" data-field="GoogleTitle" />
            </td>
            <td>
                <span class="view-mode">@p.GoogleDescription</span>
                <textarea class="edit-mode d-none form-control form-control-sm" rows="3" data-field="GoogleDescription">@p.GoogleDescription</textarea>
            </td>
            <td>
                <div class="view-mode d-flex gap-1 align-items-center justify-content-end">
                    <button class="btn btn-outline-primary btn-sm edit-btn btn-icon-label" type="button">✏ <span class="btn-label">aanpassen</span></button>
                    <form method="post" action="@Url.Action("MoveUp", new { id = p.Id })" style="display:inline;">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-secondary btn-sm" title="Plaats hoger" @(isFirst ? "disabled" : "")>▲</button>
                    </form>
                    <form method="post" action="@Url.Action("MoveDown", new { id = p.Id })" style="display:inline;">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-secondary btn-sm" title="Plaats lager" @(isLast ? "disabled" : "")>▼</button>
                    </form>
                </div>
                <div class="edit-mode d-none">
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-success btn-sm save-btn">Opslaan</button>
                        <button type="button" class="btn btn-secondary btn-sm cancel-btn">Annuleren</button>
                    </div>
                </div>
            </td>
        </tr>
    }
    <tr class="new-page-row">
        <form method="post" action="@Url.Action("Create")" class="new-page-form">
            @Html.AntiForgeryToken()
            <td>
                <input type="text" name="Title" class="form-control form-control-sm" placeholder="Nieuwe pagina titel" required />
            </td>
            <td>
                <input type="text" name="MenuItem" class="form-control form-control-sm" placeholder="Menu item" />
            </td>
            <td>
                <input type="text" name="GoogleTitle" class="form-control form-control-sm" placeholder="Google titel" />
            </td>
            <td>
                <textarea name="GoogleDescription" class="form-control form-control-sm" rows="3" placeholder="Google omschrijving"></textarea>
            </td>
            <td class="text-end">
                <button type="submit" class="btn btn-success btn-sm">Pagina toevoegen</button>
            </td>
        </form>
    </tr>
    </tbody>
</table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editBtns = document.querySelectorAll('.edit-btn');
        const cancelBtns = document.querySelectorAll('.cancel-btn');
        const saveBtns = document.querySelectorAll('.save-btn');

        editBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const row = this.closest('.page-row');
                const viewElements = row.querySelectorAll('.view-mode');
                const editElements = row.querySelectorAll('.edit-mode');
                
                viewElements.forEach(el => el.classList.add('d-none'));
                editElements.forEach(el => el.classList.remove('d-none'));
            });
        });

        cancelBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const row = this.closest('.page-row');
                const viewElements = row.querySelectorAll('.view-mode');
                const editElements = row.querySelectorAll('.edit-mode');
                
                editElements.forEach(el => el.classList.add('d-none'));
                viewElements.forEach(el => el.classList.remove('d-none'));
            });
        });

        saveBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const row = this.closest('.page-row');
                const pageId = row.getAttribute('data-page-id');
                const formData = new FormData();
                
                formData.append('Id', pageId);
                formData.append('Title', row.querySelector('[data-field="Title"]').value);
                formData.append('MenuItem', row.querySelector('[data-field="MenuItem"]').value);
                formData.append('GoogleTitle', row.querySelector('[data-field="GoogleTitle"]').value);
                formData.append('GoogleDescription', row.querySelector('[data-field="GoogleDescription"]').value);
                
                // Add anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    formData.append('__RequestVerificationToken', token.value);
                }
                
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'Opslaan...';

                fetch('@Url.Action("Edit", "Pages")', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        // Update view mode spans
                        const spans = row.querySelectorAll('td > .view-mode');
                        spans[0].textContent = formData.get('Title') || '';
                        spans[1].textContent = formData.get('MenuItem') || '';
                        spans[2].textContent = formData.get('GoogleTitle') || '';
                        spans[3].textContent = formData.get('GoogleDescription') || '';
                        
                        // Switch back to view mode
                        row.querySelectorAll('.edit-mode').forEach(el => el.classList.add('d-none'));
                        row.querySelectorAll('.view-mode').forEach(el => el.classList.remove('d-none'));
                        
                        btn.textContent = originalText;
                        btn.disabled = false;
                    } else {
                        throw new Error('Save failed');
                    }
                })
                .catch(error => {
                    alert('Fout bij opslaan. Probeer het opnieuw.');
                    btn.textContent = originalText;
                    btn.disabled = false;
                });
            });
        });
    });
</script>