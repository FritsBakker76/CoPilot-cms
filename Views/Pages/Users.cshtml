@model IEnumerable<CmsModern.Models.User>
@{
    ViewData["Title"] = "Users";
}

@if (TempData["Message"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Message"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="container py-4">
<style>
    .table th:nth-child(1),
    .table td:nth-child(1) {
        width: 25%;
    }
    .table th:nth-child(2),
    .table td:nth-child(2) {
        width: 15%;
    }
    .table th:nth-child(3),
    .table td:nth-child(3) {
        width: 30%;
    }
    .table th:nth-child(4),
    .table td:nth-child(4) {
        width: 32%;
    }
    .table {
        table-layout: fixed;
    }
</style>
<table class="table table-striped">
    <thead>
        <tr>
            <th>Gebruikersnaam</th>
            <th>Is Admin</th>
            <th>Wachtwoord</th>
            <th class="text-end">Acties</th>
        </tr>
    </thead>
    <tbody>
    @{
        var usersList = Model.ToList();
    }
    @for (int i = 0; i < usersList.Count; i++)
    {
        var user = usersList[i];
        <tr class="user-row" data-user-id="@user.Id">
            <td>
                <span class="view-mode">@user.Username</span>
                <input type="text" class="edit-mode d-none form-control form-control-sm" value="@user.Username" data-field="username" required />
            </td>
            <td>
                <span class="view-mode">@(user.IsAdmin ? "Ja" : "Nee")</span>
                <div class="edit-mode d-none form-check mt-2">
                    <input class="form-check-input" type="checkbox" data-field="isAdmin" id="isAdmin@user.Id" @(user.IsAdmin ? "checked" : "") />
                    <label class="form-check-label" for="isAdmin@user.Id">Admin</label>
                </div>
            </td>
            <td>
                <span class="view-mode">-</span>
                <input type="password" class="edit-mode d-none form-control form-control-sm" data-field="password" placeholder="Nieuw wachtwoord (optioneel)" />
            </td>
            <td>
                <div class="view-mode text-end">
                    @if (user.Username != "admin" || string.Equals(User.Identity?.Name, "admin", StringComparison.OrdinalIgnoreCase))
                    {
                        <button class="btn btn-outline-primary btn-sm edit-btn btn-icon-label" type="button">‚úè <span class="btn-label">aanpassen</span></button>
                    }
                </div>
                <div class="edit-mode d-none">
                    <div class="d-flex gap-1 justify-content-end">
                        <button type="button" class="btn btn-success btn-sm save-btn">Opslaan</button>
                        <button type="button" class="btn btn-secondary btn-sm cancel-btn">Annuleren</button>
                        @if (user.Username != "admin")
                        {
                            <button type="button" class="btn btn-danger btn-sm delete-btn" data-user-id="@user.Id">Verwijderen</button>
                        }
                    </div>
                </div>
            </td>
        </tr>
    }
    <tr class="new-user-row">
        <form method="post" action="@Url.Action("CreateUser", "Pages")" class="new-user-form" style="display: contents;">
            @Html.AntiForgeryToken()
            <td>
                <input type="text" name="username" class="form-control form-control-sm" placeholder="Gebruikersnaam" required />
            </td>
            <td>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" name="isAdmin" id="isAdminNew" />
                    <label class="form-check-label" for="isAdminNew">Admin</label>
                </div>
            </td>
            <td>
                <input type="password" name="password" class="form-control form-control-sm" placeholder="Wachtwoord" required />
            </td>
            <td class="text-end">
                <button type="submit" class="btn btn-success btn-sm">Gebruiker toevoegen</button>
            </td>
        </form>
    </tr>
    </tbody>
</table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editBtns = document.querySelectorAll('.edit-btn');
        const cancelBtns = document.querySelectorAll('.cancel-btn');
        const saveBtns = document.querySelectorAll('.save-btn');
        const deleteBtns = document.querySelectorAll('.delete-btn');

        editBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const row = this.closest('.user-row');
                const viewElements = row.querySelectorAll('.view-mode');
                const editElements = row.querySelectorAll('.edit-mode');

                viewElements.forEach(el => el.classList.add('d-none'));
                editElements.forEach(el => el.classList.remove('d-none'));
            });
        });

        cancelBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const row = this.closest('.user-row');
                const viewElements = row.querySelectorAll('.view-mode');
                const editElements = row.querySelectorAll('.edit-mode');

                editElements.forEach(el => el.classList.add('d-none'));
                viewElements.forEach(el => el.classList.remove('d-none'));
            });
        });

        saveBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const row = this.closest('.user-row');
                const userId = row.getAttribute('data-user-id');
                const formData = new FormData();
                
                formData.append('id', userId);
                formData.append('username', row.querySelector('[data-field="username"]').value);
                formData.append('isAdmin', row.querySelector('[data-field="isAdmin"]').checked);
                const password = row.querySelector('[data-field="password"]').value;
                if (password) {
                    formData.append('password', password);
                }
                
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    formData.append('__RequestVerificationToken', token.value);
                }
                
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'Opslaan...';

                fetch('@Url.Action("EditUser", "Pages")', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        // Update view mode spans
                        const spans = row.querySelectorAll('td > .view-mode');
                        spans[0].textContent = formData.get('username') || '';
                        spans[1].textContent = formData.get('isAdmin') === 'true' ? 'Ja' : 'Nee';
                        
                        // Switch back to view mode
                        row.querySelectorAll('.edit-mode').forEach(el => el.classList.add('d-none'));
                        row.querySelectorAll('.view-mode').forEach(el => el.classList.remove('d-none'));
                        
                        btn.textContent = originalText;
                        btn.disabled = false;
                    } else {
                        throw new Error('Save failed');
                    }
                })
                .catch(error => {
                    alert('Fout bij opslaan. Probeer het opnieuw.');
                    btn.textContent = originalText;
                    btn.disabled = false;
                });
            });
        });

        deleteBtns.forEach(btn => {
            btn.addEventListener('click', function (e) {
                if (!confirm('Weet je zeker dat je deze gebruiker wilt verwijderen?')) {
                    return;
                }
                e.preventDefault();
                const userId = this.getAttribute('data-user-id');
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("DeleteUser", "Pages")';
                
                const inputId = document.createElement('input');
                inputId.type = 'hidden';
                inputId.name = 'id';
                inputId.value = userId;
                
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    const tokenClone = token.cloneNode(true);
                    form.appendChild(tokenClone);
                }
                form.appendChild(inputId);
                document.body.appendChild(form);
                form.submit();
            });
        });
    });
</script>
