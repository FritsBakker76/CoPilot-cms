@model CmsModern.Models.Page
@{
    ViewData["Title"] = Model.Title;
    ViewData["GoogleTitle"] = Model.GoogleTitle;
    ViewData["GoogleDescription"] = Model.GoogleDescription;
    var contents = ViewBag.Contents as List<CmsModern.Models.PageContent>;
}

@if (User.Identity.IsAuthenticated)
{
    <div class="d-flex justify-content-end align-items-center gap-2 mb-3 mt-3">
        @if (ViewBag.EditMode != null && (bool)ViewBag.EditMode)
        {
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="addDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Alinea toevoegen
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="addDropdown">
                    <li>
                        <a class="dropdown-item" href="@Url.Action("PageTemplates", "Home", new { pageId = Model.Id, position = "top" })">Alinea bovenaan de pagina</a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="@Url.Action("PageTemplates", "Home", new { pageId = Model.Id, position = "bottom" })">Alinea onderaan de pagina</a>
                    </li>
                </ul>
            </div>
            <a href="@Url.Action("Page", "Home", new { id = Model.Id })" class="btn btn-outline-primary">Aanpassen sluiten</a>
        }
        else
        {
            <a href="@Url.Action("Page", "Home", new { id = Model.Id, edit = true })" class="btn btn-outline-primary">Pagina aanpassen</a>
        }
    </div>
}

@if (ViewBag.EditMode != null && (bool)ViewBag.EditMode)
{
    <div class="card content-card toggle-card mb-4 position-relative">
        <div class="position-absolute top-0 end-0 m-2 d-flex gap-1">
            <button type="button" class="btn btn-sm btn-outline-primary edit-btn btn-icon-label">‚úè <span class="btn-label">aanpassen</span></button>
            <button type="button" class="btn btn-sm btn-secondary cancel-btn d-none">‚úñ annuleren</button>
            <button type="submit" form="page-header-form" class="btn btn-sm btn-success save-btn d-none">‚úî opslaan</button>
        </div>
        <div class="card-body">
            <div class="content-view">
                <h1 class="display-4">@Model.Title</h1>
                <p class="lead">@Model.Description</p>
            </div>
            <form id="page-header-form" class="content-edit d-none" method="post" action="@Url.Action("SavePageHeader", "Home")">
                @Html.AntiForgeryToken()
                <input type="hidden" name="pageId" value="@Model.Id" />
                <div class="mb-3">
                    <label class="form-label">Paginatitel</label>
                    <input type="text" name="pageTitle" value="@Model.Title" class="form-control" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Pagina omschrijving</label>
                    <textarea name="pageDescription" class="form-control" style="min-height: 100px;">@Model.Description</textarea>
                </div>
            </form>
        </div>
    </div>
    @foreach (var content in contents)
    {
        var isFirst = content.Position == contents.Min(c => c.Position);
        var isLast = content.Position == contents.Max(c => c.Position);
        <div class="card content-card toggle-card mb-4 position-relative">
            <div class="position-absolute top-0 end-0 m-2 d-flex gap-1">
                <div class="action-group d-flex gap-1">
                    <button type="button" class="btn btn-sm btn-outline-primary edit-btn btn-icon-label">‚úè <span class="btn-label">aanpassen</span></button>
                    <form method="post" action="@Url.Action("MoveContentUp", "Home")" class="d-inline" style="margin: 0;">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="pageId" value="@Model.Id" />
                        <input type="hidden" name="contentId" value="@content.Id" />
                        <button type="submit" class="btn btn-sm btn-outline-secondary" @(isFirst ? "disabled" : "")>‚ñ≤</button>
                    </form>
                    <form method="post" action="@Url.Action("MoveContentDown", "Home")" class="d-inline" style="margin: 0;">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="pageId" value="@Model.Id" />
                        <input type="hidden" name="contentId" value="@content.Id" />
                        <button type="submit" class="btn btn-sm btn-outline-secondary" @(isLast ? "disabled" : "")>‚ñº</button>
                    </form>
                    <button type="button" class="btn btn-sm btn-secondary cancel-btn d-none">‚úñ annuleren</button>
                    <button type="submit" form="edit-form-@content.Id" class="btn btn-sm btn-success save-btn d-none">‚úî opslaan</button>
                    <button type="button" class="btn btn-sm btn-outline-danger delete-btn">üóë</button>
                </div>
                <form method="post" action="@Url.Action("DeleteContentSection", "Home")" class="delete-actions d-none d-inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="pageId" value="@Model.Id" />
                    <input type="hidden" name="contentId" value="@content.Id" />
                    <button type="button" class="btn btn-sm btn-secondary delete-cancel">‚úñ annuleren</button>
                    <button type="submit" class="btn btn-sm btn-danger">üóë alinea verwijderen</button>
                </form>
            </div>
            <div class="card-body">
                <div class="content-view">
                    @if (content.Type == "alinea#1")
                    {
                        @if (!string.IsNullOrEmpty(content.Title))
                        {
                            <h3>@content.Title</h3>
                        }
                        @if (!string.IsNullOrEmpty(content.Content))
                        {
                            <div>@Html.Raw(content.Content)</div>
                        }
                    }
                    else if (content.Type == "alinea#2")
                    {
                        @if (!string.IsNullOrEmpty(content.Title))
                        {
                            <h3>@content.Title</h3>
                        }
                        <div class="row">
                            <div class="col-9">
                                @if (!string.IsNullOrEmpty(content.Content))
                                {
                                    @Html.Raw(content.Content)
                                }
                            </div>
                            <div class="col-3 ms-auto">
                                @if (!string.IsNullOrEmpty(content.PictureText))
                                {
                                    <img src="@content.PictureText" class="img-fluid" style="height: 160px; width: 100%; object-fit: contain;" alt="Image" />
                                }
                                else
                                {
                                    <img src="/images/placeholder.jpg" class="img-fluid" style="height: 160px; width: 100%; object-fit: contain;" alt="Placeholder" />
                                }
                            </div>
                        </div>
                    }
                    else if (content.Type == "alinea#3")
                    {
                        @if (!string.IsNullOrEmpty(content.Title))
                        {
                            <h3>@content.Title</h3>
                        }
                        <div class="row">
                            <div class="col-3 me-auto">
                                @if (!string.IsNullOrEmpty(content.PictureText))
                                {
                                    <img src="@content.PictureText" class="img-fluid" style="height: 160px; width: 100%; object-fit: contain;" alt="Image" />
                                }
                                else
                                {
                                    <img src="/images/placeholder.jpg" class="img-fluid" style="height: 160px; width: 100%; object-fit: contain;" alt="Placeholder" />
                                }
                            </div>
                            <div class="col-9">
                                @if (!string.IsNullOrEmpty(content.Content))
                                {
                                    @Html.Raw(content.Content)
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        @if (!string.IsNullOrEmpty(content.Title))
                        {
                            <h3>@content.Title</h3>
                        }
                        @if (!string.IsNullOrEmpty(content.Content))
                        {
                            <div>@Html.Raw(content.Content)</div>
                        }
                        @if (!string.IsNullOrEmpty(content.PictureText))
                        {
                            <img src="@content.PictureText" class="img-fluid" style="height: 160px; width: 100%; object-fit: contain;" alt="Image" />
                        }
                    }
                </div>

                <form id="edit-form-@content.Id" class="content-edit d-none" method="post" action="@Url.Action("SaveContentSection", "Home")">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="pageId" value="@Model.Id" />
                    <input type="hidden" name="Id" value="@content.Id" />
                    <input type="hidden" name="Type" value="@content.Type" />
                    <input type="hidden" name="Position" value="@content.Position" />
                    <input type="hidden" name="Link" value="@content.Link" />
                    <input type="hidden" name="Price" value="@content.Price" />
                    <input type="hidden" name="Duration" value="@content.Duration" />
                    <input type="hidden" name="PictureText" value="@content.PictureText" />

                    @if (content.Type == "alinea#1")
                    {
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label>Title</label>
                                <input type="text" name="Title" value="@content.Title" class="form-control" />
                            </div>
                            <div class="col-12">
                                <label>Content</label>
                                <textarea name="Content" class="form-control" style="min-height: 120px;">@content.Content</textarea>
                            </div>
                        </div>
                    }
                    else if (content.Type == "alinea#2")
                    {
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label>Title</label>
                                <input type="text" name="Title" value="@content.Title" class="form-control" />
                            </div>
                            <div class="row">
                                <div class="col-9 mb-3">
                                    <label>Content</label>
                                    <textarea name="Content" class="form-control" style="min-height: 120px;">@content.Content</textarea>
                                </div>
                                <div class="col-3 ms-auto">
                                    <img src="/images/placeholder.jpg" class="img-fluid" style="height: 160px; width: 100%; object-fit: contain;" alt="Placeholder" />
                                </div>
                            </div>
                        </div>
                    }
                    else if (content.Type == "alinea#3")
                    {
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label>Title</label>
                                <input type="text" name="Title" value="@content.Title" class="form-control" />
                            </div>
                            <div class="row">
                                <div class="col-3 mb-3 me-auto">
                                    <img src="/images/placeholder.jpg" class="img-fluid" style="height: 160px; width: 100%; object-fit: contain;" alt="Placeholder" />
                                </div>
                                <div class="col-9">
                                    <label>Content</label>
                                    <textarea name="Content" class="form-control" style="min-height: 120px;">@content.Content</textarea>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="mb-2">
                            <label>Title</label>
                            <input type="text" name="Title" value="@content.Title" class="form-control" />
                        </div>
                        <div class="mb-2">
                            <label>Content</label>
                            <textarea name="Content" class="form-control" style="min-height: 120px;">@content.Content</textarea>
                        </div>
                    }
                </form>
            </div>
        </div>
    }
}
else
{
    <div class="text-start">
        <h1 class="display-4">@Model.Title</h1>
        <p class="lead">@Model.Description</p>
        @foreach (var content in ViewBag.Contents as List<CmsModern.Models.PageContent>)
        {
            <div class="content-item mb-4">
                @if (content.Type == "alinea#1")
                {
                    @if (!string.IsNullOrEmpty(content.Title))
                    {
                        <h3>@content.Title</h3>
                    }
                    @if (!string.IsNullOrEmpty(content.Content))
                    {
                        <div>@Html.Raw(content.Content)</div>
                    }
                }
                else if (content.Type == "alinea#2")
                {
                    @if (!string.IsNullOrEmpty(content.Title))
                    {
                        <h3>@content.Title</h3>
                    }
                    <div class="row">
                        <div class="col-9">
                            @if (!string.IsNullOrEmpty(content.Content))
                            {
                                @Html.Raw(content.Content)
                            }
                        </div>
                        <div class="col-3 ms-auto">
                            @if (!string.IsNullOrEmpty(content.PictureText))
                            {
                                <img src="@content.PictureText" class="img-fluid" style="height: 160px; width: 100%; object-fit: contain;" alt="Image" />
                            }
                            else
                            {
                                <img src="/images/placeholder.jpg" class="img-fluid" style="height: 160px; width: 100%; object-fit: contain;" alt="Placeholder" />
                            }
                        </div>
                    </div>
                }
                else if (content.Type == "alinea#3")
                {
                    @if (!string.IsNullOrEmpty(content.Title))
                    {
                        <h3>@content.Title</h3>
                    }
                    <div class="row">
                        <div class="col-3 me-auto">
                            @if (!string.IsNullOrEmpty(content.PictureText))
                            {
                                <img src="@content.PictureText" class="img-fluid" style="height: 160px; width: 100%; object-fit: contain;" alt="Image" />
                            }
                            else
                            {
                                <img src="/images/placeholder.jpg" class="img-fluid" style="height: 160px; width: 100%; object-fit: contain;" alt="Placeholder" />
                            }
                        </div>
                        <div class="col-9">
                            @if (!string.IsNullOrEmpty(content.Content))
                            {
                                @Html.Raw(content.Content)
                            }
                        </div>
                    </div>
                }
                else
                {
                    @if (!string.IsNullOrEmpty(content.Title))
                    {
                        <h3>@content.Title</h3>
                    }
                    @if (!string.IsNullOrEmpty(content.Content))
                    {
                        <div>@Html.Raw(content.Content)</div>
                    }
                    @if (!string.IsNullOrEmpty(content.Link))
                    {
                        <a href="@content.Link" class="btn btn-primary">Learn More</a>
                    }
                    @if (content.Price.HasValue)
                    {
                        <p><strong>Price: $@content.Price</strong></p>
                    }
                    @if (!string.IsNullOrEmpty(content.Duration))
                    {
                        <p>Duration: @content.Duration</p>
                    }
                    @if (!string.IsNullOrEmpty(content.PictureText))
                    {
                        <p>@content.PictureText</p>
                    }
                }
            </div>
        }
    </div>
}

@section Scripts {
    <script>
        $(function () {
            $('.toggle-card').each(function () {
                var card = $(this);
                var view = card.find('.content-view');
                var edit = card.find('.content-edit');
                var editBtn = card.find('.edit-btn');
                var cancelBtn = card.find('.cancel-btn');
                var saveBtn = card.find('.save-btn');
                var deleteBtn = card.find('.delete-btn');
                var actionGroup = card.find('.action-group');
                var deleteActions = card.find('.delete-actions');
                var deleteCancel = card.find('.delete-cancel');

                editBtn.on('click', function () {
                    view.addClass('d-none');
                    edit.removeClass('d-none');
                    editBtn.addClass('d-none');
                    cancelBtn.removeClass('d-none');
                    saveBtn.removeClass('d-none');
                    deleteBtn.addClass('d-none');
                    deleteActions.addClass('d-none');
                    actionGroup.removeClass('d-none');
                    card.addClass('card-editing');

                    // Hide action buttons on all other sections/cards while editing this one
                    $('.toggle-card').not(card).each(function () {
                        var other = $(this);
                        other.find('.action-group').addClass('d-none');
                        other.find('.delete-actions').addClass('d-none');
                        other.find('.edit-btn').addClass('d-none');
                        other.find('.cancel-btn').addClass('d-none');
                        other.find('.save-btn').addClass('d-none');
                        other.find('.delete-btn').addClass('d-none');
                    });
                });

                cancelBtn.on('click', function () {
                    edit.addClass('d-none');
                    view.removeClass('d-none');
                    editBtn.removeClass('d-none');
                    cancelBtn.addClass('d-none');
                    saveBtn.addClass('d-none');
                    deleteBtn.removeClass('d-none');
                    card.removeClass('card-editing');

                    // Restore action buttons on other sections/cards
                    $('.toggle-card').not(card).each(function () {
                        var other = $(this);
                        other.find('.action-group').removeClass('d-none');
                        other.find('.delete-actions').addClass('d-none');
                        other.find('.edit-btn').removeClass('d-none');
                        other.find('.cancel-btn').addClass('d-none');
                        other.find('.save-btn').addClass('d-none');
                        other.find('.delete-btn').removeClass('d-none');
                    });
                });

                deleteBtn.on('click', function () {
                    actionGroup.addClass('d-none');
                    deleteActions.removeClass('d-none');
                });

                deleteCancel.on('click', function () {
                    deleteActions.addClass('d-none');
                    actionGroup.removeClass('d-none');
                    if (!edit.hasClass('d-none')) {
                        // Still in edit mode: keep delete icon hidden
                        deleteBtn.addClass('d-none');
                    } else {
                        deleteBtn.removeClass('d-none');
                    }
                });
            });
        });
    </script>
}